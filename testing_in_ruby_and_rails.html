---
layout: null
---

<!DOCTYPE html>
<html>
  <head>
    <title>Testing in Ruby on Rails</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, mRails

# Testing in Ruby and Rails

*From someone doesn't like writing test*

---

## Táº¡i sao cáº§n viáº¿t test?

Theo CÃ´ng ty:
* CÃ¡c quy trÃ¬nh phÃ¡t triá»ƒn pháº§n má»m Ä‘á»u yÃªu cáº§u pháº£i viáº¿t test

=> Viáº¿t test lÃ  quy Ä‘á»‹nh báº¯t buá»™c trong cÃ¡c dá»± Ã¡n.

Theo google: ğŸ˜

* Giáº£m bug.
* Cung cáº¥p document cho code.
* Há»— trá»£ viá»‡c thiáº¿t káº¿ code (test first).

=>  Má»¥c Ä‘Ã­ch chÃ­nh cá»§a viá»‡c viáº¿t test lÃ  giáº£m thiá»ƒu cost khi phÃ¡t triá»ƒn pháº§n má»m.

---

## Váº¥n Ä‘á»

- Thá»±c táº¿:
    - `coding effort < writing test effort`.

**NguyÃªn nhÃ¢n lÃ  do chÃºng ta chÆ°a tráº£ lá»i Ä‘Æ°á»£c cÃ¡c cÃ¢u há»i**:
* `Why` -- Má»¥c Ä‘Ã­ch cá»§a viá»‡c viáº¿t test.
* `What` -- Test cÃ¡i gÃ¬?
* `When` -- Test khi nÃ o?
* `How` -- Test nhÆ° tháº¿ nÃ o?

---
## `Why` - Má»¥c Ä‘Ã­ch cá»§a viá»‡c viáº¿t test

### 1. TÃ¬m bugs

- Thá»±c táº¿:
  - ChÃºng ta khÃ´ng cover Ä‘Æ°á»£c toÃ n bá»™ cÃ¡c tÃ­nh nÄƒng trong dá»± Ã¡n
  => KhÃ´ng náº¯m Ä‘Æ°á»£c sá»± áº£nh hÆ°á»Ÿng code cá»§a mÃ¬nh.
  - Dependencies, code base sáº½ ngÃ y cÃ ng lá»›n hÆ¡n
  => Náº¿u phÃ¡t hiá»‡n bug cháº­m thÃ¬ sáº½ pháº£i sá»­a á»Ÿ nhiá»u chá»—.
  - Náº¿u Ä‘á»ƒ QA tÃ¬m ra bug
  => Máº¥t thá»i gian confirm qua láº¡i, assign láº¡i ticket, tÃ¬m bug, retest, ... sáº½ áº£nh hÆ°á»Ÿng tá»›i tiáº¿n Ä‘á»™ dá»± Ã¡n.

- Sá»­ dá»¥ng test:
  - TÃ¬m ra bug sá»›m hÆ¡n => Fix bug sáº½ dá»… hÆ¡n do dependencies táº¡i thá»i Ä‘iá»ƒm code Ã­t hÆ¡n.
  - NgÆ°á»i khÃ¡c khi code tÃ­nh nÄƒng cá»§a há», cháº¡y láº¡i bá»™ test Ä‘Ã£ Ä‘Æ°á»£c viáº¿t, náº¿u áº£nh hÆ°á»Ÿng tá»›i tÃ­nh nÄƒng khÃ¡c thÃ¬ cháº¿t test, sáº½ phÃ¡t hiá»‡n Ä‘Æ°á»£c ngay.

---

## `Why` -- Má»¥c Ä‘Ã­ch cá»§a viá»‡c viáº¿t test

### 2. Cung cáº¥p documentation
- Thá»±c táº¿:
      - Code lÃ¢u sáº½ quÃªn spec ğŸ˜³
      - ÄÃ´i khi chÃºng ta khÃ´ng hiá»ƒu Ä‘Æ°á»£c táº¡i sao dev A láº¡i viáº¿t code nhÆ° tháº¿ nÃ y.
      - KhÃ´ng biáº¿t sá»­ dá»¥ng code ngÆ°á»i khÃ¡c viáº¿t nhÆ° tháº¿ nÃ o.

- Sá»­ dá»¥ng test:
      - NhÃ¬n vÃ o test ta cÃ³ thá»ƒ suy ra Ä‘Æ°á»£c spec má»™t cÃ¡ch nhanh gá»n + Ä‘Æ¡n giáº£n nháº¥t.

- Ref: [devise gem -
password_controller_test.rb](https://github.com/plataformatec/devise/blob/master/test/controllers/passwords_controller_test.rb)
---

## `Why` -- Má»¥c Ä‘Ã­ch cá»§a viá»‡c viáº¿t test
### 3. Há»— trá»£ thiáº¿t káº¿ code & phÃ¡t hiá»‡n Ä‘iá»ƒm yáº¿u trong code.
- Thá»±c táº¿:
      - ChÃºng ta khÃ´ng cÃ³ Ä‘á»§ cÃ¡c thÃ´ng tin Ä‘á»ƒ thiáº¿t káº¿ code 1 cÃ¡ch tá»‘t nháº¥t ngay tá»« Ä‘áº§u. LuÃ´n cÃ³ sá»± thay Ä‘á»•i, má»Ÿ rá»™ng tÃ­nh nÄƒng
       => ÄÃ´i khi chÃºng ta viáº¿t code Ä‘ang chá»‰ giáº£i quyáº¿t cho case hiá»‡n táº¡i, chá» thÃªm thÃ´ng tin Ä‘á»ƒ thiáº¿t káº¿ tá»‘t hÆ¡n.
      - Tháº¥y khÃ³ Ä‘á»ƒ viáº¿t test cho Ä‘oáº¡n code mÃ¬nh vá»«a viáº¿t ra, pháº£i khá»Ÿi táº¡o, setup quÃ¡ nhiá»u, gá»i tá»›i nhiá»u services, models, ...
- Sá»­ dá»¥ng test:
      - Khi cÃ³ thÃªm thÃ´ng tin, ta thay Ä‘á»•i code base, do Ä‘Ã£ cÃ³ test trÆ°á»›c Ä‘Ã³ rá»“i
      => Ta sáº½ tá»± tin thay Ä‘á»•i hÆ¡n, chá»‰ cáº§n bá»™ test case cho pháº§n Ä‘Ã³ váº«n hoáº¡t Ä‘á»™ng Ä‘Ãºng.
      - Náº¿u tháº¥y khÃ³ viáº¿t test cho Ä‘oáº¡n mÃ¬nh vá»«a viáº¿t, thÃ¬ cÃ³ thá»ƒ lÃ  do code Ä‘ang thá»±c hiá»‡n quÃ¡ nhiá»u viá»‡c, nhiá»u context, ..
      => KhÃ´ng Ä‘Ãºng vá»›i cÃ¡c nguyÃªn táº¯c cá»§a SOLID.
      - Viáº¿t test khÃ³, chá»©ng tá» lÃ  cÃ¡c object khÃ¡c khi sá»­ dá»¥ng láº¡i code cÅ©ng khÃ³.

---

## `What` -- Test cÃ¡i gÃ¬?
- Thá»±c táº¿:
      - Ta thÆ°á»ng khÃ´ng viáº¿t test hoáº·c viáº¿t quÃ¡ nhiá»u test.
      - Test khÃ´ng cáº§n thiáº¿t lÃ m cháº­m quÃ¡ trÃ¬nh check CI.

=> Cáº§n DRY test, viáº¿t test Ä‘Ãºng chá»—.

- Rails: **Má»i Ä‘oáº¡n code logic Ä‘á»u nÃªn Ä‘Æ°á»£c viáº¿t test (model, lib, services, supports, ..)**

---
## `What` -- Test cÃ¡i gÃ¬?

- OOP: Má»™t object thÆ°á»ng bao gá»“m: `data` vÃ  `messages`
```ruby
class Foo
      attr_reader :foo_bar

      def initialize foo_bar
        @foo_bar = foo_bar
      end

      def incomming
        Bar.new(foo_bar).outgoing
      end

      private
      def private_method
        # logic here
      end
end
```

---
## `What` -- Test cÃ¡i gÃ¬?

- Message type:
  * Incomming messages: nhá»¯ng hÃ m public cá»§a 1 object.
  * Outgoing messages: nhá»¯ng hÃ m public cá»§a object khÃ¡c mÃ  object hiá»‡n táº¡i Ä‘ang gá»i tá»›i.

- Message test:
  - Äá»‘i vá»›i incomming messages, ta cáº§n test giÃ¡ trá»‹ tráº£ vá» cá»§a nÃ³. Chá»‰ cáº§n so sÃ¡nh giÃ¡ trá»‹ tráº£ vá» cá»§a hÃ m báº±ng 1 giÃ¡ trá»‹ mong muá»‘n. (state test)
  - Outgoing messages thÃ¬ k cáº§n pháº£i state test. VÃ¬ nÃ³ Ä‘Ã£ Ä‘Æ°á»£c test á»Ÿ class define nÃ³ rá»“i.

---
## `What` -- Test cÃ¡i gÃ¬?

- Outgoing messages:
      * Query messages: Nhá»¯ng methods khÃ´ng cÃ³ hiá»‡u á»©ng phá»¥ (ghi file, ghi DB, goi API ngoÃ i, ...).
      * Command messages: Nhá»¯ng methods cÃ³ hiá»‡u á»©ng phá»¥.

- Outgoing messages test:
      * Query messages khÃ´ng cáº§n test vÃ¬ Ä‘Æ¡n giáº£n nÃ³ chá»‰ tráº£ vá» giÃ¡ trá»‹.
      * Command messages: Cáº§n test nhÆ°ng test dÆ°á»›i dáº¡ng behavior test: test xem message Ä‘Æ°á»£c gá»i bao nhiÃªu láº§n, vá»›i tham sá»‘ gÃ¬, ...

Vd:
```ruby
let(:foo_bar) { "foo_bar" }
let(:result) { "Result" }
it "should call outgoing messsage from bar object" do
  expect(Bar).to receive_message_chain(:new, :outgoing)
    .with(foo_bar).with(no_args).and_return result
end
```
---
## `When` -- Test khi nÃ o?

- Theo google:
      - NÃªn viáº¿t test trÆ°á»›c khi viáº¿t code. VÃ¬ nÃ³ giÃºp ta Ä‘á»‹nh hÆ°á»›ng viá»‡c thiáº¿t káº¿ code tá»‘t hÆ¡n, Ã­t phá»¥ thuá»™c vÃ o nhau, cÃ³ tÃ­nh tÃ¡i sá»­ dá»¥ng cao.

- Thá»±c táº¿:
      - ... (yaoming)

---
## `How` -- Test nhÆ° tháº¿ nÃ o?

- CÃ¡c loáº¡i object trong app:
      - Object Ä‘ang test: instance object cá»§a class Ä‘ang test
      - Nhá»¯ng object cÃ²n láº¡i: lÃ  nhá»¯ng instance objects cá»§a cÃ¡c class khÃ¡c mÃ  Ä‘Æ°á»£c gá»i táº¡i class Ä‘ang test.

- **Chá»‰ quan tÃ¢m tá»›i object Ä‘ang test, ignore nhá»¯ng object cÃ²n láº¡i**

CÃ¡c object cÃ²n láº¡i sáº½ dÃ¹ng mock, stub, double,.. Ä‘á»ƒ táº¡o á»Ÿ bÃªn trÃªn vÃ  gá»i láº¡i á»Ÿ trong test.

- **Táº¥t cáº£ cÃ¡c method public cá»§a object Ä‘á»u cáº§n pháº£i test**

Cáº§n test Ä‘Ãºng giÃ¡ trá»‹ tráº£ vá» cho má»i trÆ°á»ng há»£p cÃ³ kháº£ nÄƒng xáº£y ra bÃªn trong public method Ä‘Ã³.

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
Test `incomming_messages`
```ruby
class Point
    TOTAL_SUBJECT = 15

    def initialize student
      @student = student
    end

    def average_point
      student.total_point / TOTAL_SUBJECT
    end
end
```
```ruby
# point_test.rb
# CÃ¡ch 1
describe Point do
  let(:student) {FactoryBot.create :student, math_point: 8, music_point: 6, ...}
  let(:point) {Point.new(student)}

  descirbe "#average_point" do
    it {expect(point.average_point).to eq 7.5}
  end
end
```
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
- Váº¥n Ä‘á»:
      + Tá»‘n bá»™ nhá»› khi khá»Ÿi táº¡o student mÃ  chá»‰ sá»­ dá»¥ng Ä‘á»ƒ gá»i 1 hÃ m.
      + Khi logic trong hÃ m `total_point` cá»§a student tÄƒng lÃªn sáº½ dáº«n Ä‘áº¿n cháº¡y cháº­m code cá»§a test bÃªn point.

- Giáº£i phÃ¡p: Sá»­ dá»¥ng `double` Ä‘á»ƒ **stub** gá»i hÃ m `total_point`

```ruby
# point_test.rb
# CÃ¡ch 2
describe Point do
  let(:student) {double("student"}
  let(:point) {Point.new(student)}

  descirbe "#average_point" do
    before {allow(student).to receive(:total_point).and_return(120)}
    it {expect(point.average_point).to eq 7.5}
  end
end
```
=> Chá»‰ cáº§n bÃªn student váº«n cÃ²n hÃ m `total_point` thÃ¬ Ä‘oáº¡n code trÃªn sáº½ váº«n cháº¡y nhanh.
NhÆ°ng náº¿u trong class student ta Ä‘á»•i tÃªn hÃ m thÃ¬ sao? => Viá»‡c test Role sáº½ Ä‘Æ°á»£c Ä‘á» cáº­p trong 1 bÃ i khÃ¡c :D

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
Test Outgoing messages:

- Query messages: Nhá»¯ng method khÃ´ng cÃ³ side effect. VÃ­ dá»¥ nhÆ° method `total_point` á»Ÿ trÃªn, nÃ³ Ä‘Ã£ Ä‘Æ°á»£c test á»Ÿ class Student rá»“i.

- Command messages: Nhá»¯ng method khÃ´ng chá»‰ Ä‘Æ¡n thuáº§n tráº£ vá» 1 giÃ¡ trá»‹, mÃ  cÃ²n chá»©a nhá»¯ng side effect khÃ¡c.
VÃ­ dá»¥ nhÆ°: save dá»¯ liá»‡u vÃ o db, ghi vÃ o file, gá»­i thÃ´ng bÃ¡o, ...

Ta cáº§n Ä‘áº£m báº£o viá»‡c cÃ¡c command messages nÃ y **Ä‘Æ°á»£c gá»i** Ä‘Ãºng.

---
## `How` -- Test nhÆ° tháº¿ nÃ o?

```ruby
class RegisterUser
  def initialize user, mailer
    @user = user
    @mailer = mailer
  end

  attr_reader :user, :mailer

  def perform
    user.save
    mailer.deliver_later
  end
end
```
á» Ä‘Ã¢y cÃ³ 2 tÃ¡c vá»¥ lÃ  lÆ°u vÃ  gá»­i mail. Cáº£ 2 methods Ä‘á»u tá»“n táº¡i side effect.

Ta cáº§n test instance cá»§a `RegisterUser` khi gá»i hÃ m `perform` thÃ¬ sáº½ pháº£i gá»i cáº£ hÃ m `save` cá»§a user vÃ  hÃ m `deliver_later` cá»§a `mailer` object.

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
`Mock` Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ test hÃ nh vi. Mock Ä‘á»‹nh nghÄ©a sá»± mong Ä‘á»£i má»™t method Ä‘Æ°á»£c gá»i bá»Ÿi 1 method khÃ¡c khi nÃ³ Ä‘Æ°á»£c cháº¡y.

```ruby
expect(object).to receive(:method_name).with(list_of_argument)
testing_object.send_method
```
```ruby
describe RegisterUser do
  let(:user) {double "user"}
  let(:mailer) {double "mailer"}
  let(:register_user) {RegisterUser.new user, mailer}

  describe "#perform" do
    it do
      expect(user).to receive :save
      expect(mailer).to receive :deliver_later
      register_user.perform
    end
  end
end
```
Hoáº·c cÃ³ 1 cÃ¡ch test khÃ¡c cho Ä‘oáº¡n code trÃªn:
+ Build 1 object user = FactoryBot
+ Gá»i hÃ m perform, sau Ä‘Ã³ check láº¡i xem user Ä‘Ã³ Ä‘Ã£ Ä‘Æ°á»£c save hay chÆ°a. VÃ  check xem email Ä‘Ã³ Ä‘Ã£ Ä‘Æ°á»£c gá»­i hay chÆ°a.

---
## `How` -- Test nhÆ° tháº¿ nÃ o?

Highlight recommend: http://www.betterspecs.org/

+ Describe methods, sá»­ dá»¥ng `context`, `subject`, `shared_example`, ...

---
## `How` -- Test nhÆ° tháº¿ nÃ o?

#### Rails model
- Associations
- Validations
- Queries/ Scope
- Methods
- Others: `enum`, `delegate`, `include OtherModule`, ...

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Associations + Normal Validations
```ruby
RSpec.describe Company, type: :model do
  describe "relations" do
    it { should belong_to(:client) }
    it { should have_many(:products) }
  end

  describe "validations" do
    describe "name" do
      let(:max_length) { Settings.validations.company.name.max_length }

      it { should validate_presence_of(:name).on :not_draft }
      it { should validate_length_of(:name).is_at_most max_length }
    end
  end
end
```

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Custom Validations
```ruby
# app/validators/key_name_format_validator.rb
class KeyNameFormatValidator < ActiveModel::EachValidator
  REGEX_NOT_ENGLISH = /[\u3000-\u303f\u3040-\u309f\u30a0-\u30ff\uff00-\uff9f\u4e00-\u9faf\u3400-\u4dbf]/
  REGEX_SPECIAL_CHARATERS = /[^a-zA-Z_0-9]/

  def validate_each record, attribute, value
    return if value.blank?
    if value =~ REGEX_NOT_ENGLISH
      record.errors.add attribute, :not_english
    elsif value =~ REGEX_SPECIAL_CHARATERS
      record.errors.add attribute, :special_charaters
    end
  end
end

# app/models/company.rb
class Company
  validates :key_name, key_name_format: true
end
```
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Custom Validations
Äá»ƒ test Ä‘oáº¡n custom validations trÃªn, ta cÃ³ thá»ƒ dÃ¹ng cÃ¡ch nÃ y:
```ruby
Rspec.describe Company do
  describe "validations" do
      describe "key_name" do
        it { should allow_value("abc").for :key_name }
        it { should allow_value("abc1212").for :key_name }
        it { should_not allow_value("ãŒç™º").for :key_name }
        it { should_not allow_value("a b c ").for :key_name }
      end
  end
end
```
Tuy nhiÃªn, á»Ÿ má»—i class khÃ¡c mÃ  cÃ³ sá»­ dá»¥ng chung custom validation nÃ y thÃ¬ ta sáº½ láº¡i pháº£i copy láº¡i. => Duplicate code.
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Custom Validations
Giáº£i phÃ¡p: Táº¡o 1 class "áº£o", sá»­ dá»¥ng custom validation nÃ y, sau Ä‘Ã³ test trÃªn class Ä‘Ã³.
```ruby
class KeyNameFormatValidatable
  include ActiveModel::Validations
  attr_accessor :key_name

  def initialize key_name
    @key_name = key_name
  end

  validates :key_name, key_name_format: true

  RSpec.describe KeyNameFormatValidatable, type: :validator do
    describe "shouble be valid" do
      let(:key_names_list){["abc", "abc1212"]}
      it do
        key_names_list.each do |name|
          KeyNameFormatValidatable.new(name).should be_valid
        end
      end
    end
  end
end
```
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Queries/ Scope
- Theo Ã½ kiáº¿n cÃ¡ nhÃ¢n cá»§a mÃ¬nh, Ä‘á»‘i vá»›i cÃ¡c cÃ¢u queries/ scope Ä‘Æ¡n giáº£n, ta khÃ´ng cáº§n pháº£i viáº¿t test :v
- Äá»‘i vá»›i cÃ¡c pháº§n query phá»©c táº¡p, tá»‘t nháº¥t lÃ  nÃªn tÃ¡ch ra, sá»­ dá»¥ng Query Object. Sau Ä‘Ã³ viáº¿t test cho Query Object Ä‘Ã³.

Viá»‡c sá»­ dá»¥ng cÃ¡c design pattern vá»«a giÃºp tÃ¡ch Ä‘Æ°á»£c pháº§n logic ra má»™t nÆ¡i Ä‘á»ƒ dá»… tÃ¡i sá»­ dá»¥ng, thoÃ¡ng code, mÃ  cÃ²n dá»… viáº¿t test hÆ¡n.

---

## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Methods, enum, delegate, `include OtherModule`, ...
- Theo Ã½ kiáº¿n cÃ¡ nhÃ¢n, pháº§n `enum`, `delegate` khÃ´ng cáº§n pháº£i test, vÃ¬ nÃ³ khÃ´ng chá»©a logic.
- Äá»‘i vá»›i cÃ¡c methods náº±m bÃªn trong model, ta cáº§n viáº¿t test cho táº¥t cáº£ cÃ¡c method public. (CÃ³ thá»ƒ sá»­ dá»¥ng cÃ¡ch test state, Ä‘Æ°a input vÃ  expect output).
- Äá»‘i vá»›i cÃ¡c module Ä‘Æ°á»£c include vÃ o, ta nÃªn viáº¿t test cho cÃ¡c module Ä‘Ã³ theo dáº¡ng `shared_example`, sau Ä‘Ã³ include vÃ o trong test cá»§a model.

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Rails controllers
- Trong controller chá»‰ nÃªn chá»©a nhá»¯ng logic Ä‘Æ¡n giáº£n (nhÆ° láº¥y dá»¯ liá»‡u, render, set flash message, ...). Náº¿u logic quÃ¡ phá»©c táº¡p thÃ¬ nÃªn sá»­ dá»¥ng Support hoáº·c Service Object, ...

- Khi test cho controller, chá»‰ nÃªn test theo dáº¡ng Ä‘iá»u hÆ°á»›ng request.
- Äá»‘i vá»›i cÃ¡c hÃ m create/ update, **cÃ³ thá»ƒ** test thÃªm xem dá»¯ liá»‡u Ä‘Ã£ thá»±c sá»± Ä‘Æ°á»£c update hay chÆ°a.

=> Viáº¿t test cho controller má»¥c Ä‘Ã­ch chÃ­nh lÃ  Ä‘á»ƒ Ä‘áº£m báº£o cÃ¡c trang váº«n sáº½ hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng (khÃ´ng xáº£y ra cÃ¡c lá»—i 4xx: chÆ°a login, cháº¿t trang, ....)
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
```ruby
RSpec.describe Admin::CampaignsController, type: :controller do
  describe "GET #index" do
    context "when admin didn't logged in" do
      before { get :index }
      it_behaves_like "admin unauthenticated"
    end

    context "when admin logged in" do
      let(:current_admin) { FactoryBot.create :admin }
      before do
        3.times { FactoryBot.create :campaign }
        sign_in current_admin, scope: :admin
        get :index
      end

      it "should return HTTP status code 200" do
        expect(response).to have_http_status 200
      end

      it "should render view index" do
        expect(response).to render_template :index
      end

      it "should assign @campaigns" do
        expect(assigns(:campaigns).size).to eq 3
      end
    end
  end
```

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
```ruby
describe "POST#create" do
  context "admin logged in" do
    context "invalid params" do
      let(:params) do
        { "campaign" => {"name" => nil} }
      end

      before { post :create, params: params }

      it "should return HTTP status code 200" do
        expect(response).to have_http_status 200
      end

      it "should render view new" do
        expect(response).to render_template :new
      end

      it "should return with error message" do
        expect(flash[:alert]).to eq I18n.t("admin.campaigns.create.failed")
      end

      it "should not create new campaign" do
        expect(assigns(:campaign).persisted?).to be false
      end
    end
  end
end
```
---

## `How` -- Test nhÆ° tháº¿ nÃ o?
#### Rails Object: Service Object, Query Object, Support, Decorator, ...

- CÃ¡c Object dáº¡ng nÃ y Ä‘á»u cÃ³ thá»ƒ test theo dáº¡ng state test vÃ  behavior test nhÆ° bÃªn trÃªn.

- Äá»‘i vá»›i Support, Query Object, cÃ¡ nhÃ¢n mÃ¬nh hay dÃ¹ng Mock, vÃ¬ ná»™i dung trong support chá»§ yáº¿u lÃ  tÆ°Æ¡ng tÃ¡c vá»›i DB Ä‘á»ƒ láº¥y dá»¯ liá»‡u.
- Äá»‘i vá»›i Decorator, mÃ¬nh hay dÃ¹ng kiá»ƒu state test, vÃ¬ nhá»¯ng hÃ m trong decorator thÆ°á»ng xá»­ lÃ½ logic riÃªng.

---
## `How` -- Test nhÆ° tháº¿ nÃ o?
Vd vá» sá»­ dá»¥ng Mock Ä‘á»ƒ test `supports/law.rb`
```ruby
class Supports::Law
  def cities
    @cities ||= ::City.default_order.pluck :name, :id
  end
end
```

```ruby
RSpec.describe Supports::Law do
describe "#cities" do
  it do
    expect(City).to receive_message_chain(:default_order, :pluck)
      .with(no_args).with(:name, :id)
    support.cities
  end
end
```
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
Vd vá» sá»­ dá»¥ng state test Ä‘á»ƒ test `decorators/campaign_decorator.rb`
```ruby
class CampaignDecorator < Draper::Decorator
  def total_clicks
    campaign_logs.sum(&:clicks_count)
  end
end

```
```ruby
RSpec.describe CampaignDecorator do
  describe "#total_clicks" do
    # Fake data here ....
    it "should return total impressions of user" do
      expect(campaign.decorate.total_clicks).to eq 3
    end
  end
end
```
---
## `How` -- Test nhÆ° tháº¿ nÃ o?
```ruby
class Api::V1::ChannelQuery
  attr_reader :relation

  def initialize relation = Channel.all
    @relation = relation.extending Scopes
  end

  def popular_channels_by_category category_id
    relation.joins(:videos).by_category(category_id).group_by_id.having_gt_five_videos.order_count_desc
  end

  module Scopes
    def by_category category_id
      where videos: {category_id: category_id, status: :shared}
    end

    def group_by_id
      group :id
    end

    def having_gt_five_videos
      having "count(channels.id) > ?", Settings.category.popular_channels.min_videos
    end

    def order_count_desc
      order Arel.sql("count(channels.id) desc, channels.created_at desc")
    end
  end
end
```
---
## `How` -- Test nhÆ° tháº¿ nÃ o?

```Ruby
RSpec.describe Api::V1::ChannelQuery do
  describe "#popular_channels_by_category" do
    let(:category) {FactoryBot.create :category}
    let(:channel) {FactoryBot.create :personal_channel}
    let!(:videos) do
      FactoryBot.create_list :video, 10, category: category, channel: channel, status: :shared
    end
    let!(:another_video) {FactoryBot.create :video}

    it {expect(Api::V1::ChannelQuery.new.popular_channels_by_category category.id).to eq [channel]}
  end
end
```
---
## Tá»•ng káº¿t
- WHY: Viáº¿t test ráº¥t tá»‘t cho code cá»§a mÃ¬nh vÃ  code dá»± Ã¡n. HÃ£y viáº¿t test!!!
- WHAT: CÃ³ 2 loáº¡i message lÃ  `incomming` vÃ  `outgoing` message. Táº¥t cáº£ `incomming` messages Ä‘á»u cáº§n viáº¿t test. CÃ²n outgoing thÃ¬ chá»‰ cáº§n sá»­ dá»¥ng mock Ä‘á»ƒ test nhá»¯ng method cÃ³ side effects.
- WHEN: ... (yaoming) NÃªn viáº¿t test trÆ°á»›c khi code =))
- HOW:
      + CÃ³ 2 cÃ¡ch test phá»• biáº¿n: state test (cho Ä‘áº§u vÃ o, expect Ä‘áº§u ra) vÃ  behavior test (thÆ°á»ng expect cÃ³ gá»i method)
      + Äá»‘i vá»›i Rails model, cáº§n test associations, validations, methods.
      + Äá»‘i vá»›i Rails controller, nÃªn test Ä‘Æ¡n giáº£n: test Ä‘iá»u hÆ°á»›ng request hoáº·c test xem dá»¯ liá»‡u Ä‘Ã£ Ä‘Æ°á»£c create/udpate trong db chÆ°a
      + Äá»‘i vá»›i Service Object, Query Object, Decorator, Support, ... Tuá»³ vÃ o loáº¡i object/ hÃ m cáº§n test mÃ  test theo kiá»ƒu state hoáº·c mock dá»¯ liá»‡u cho há»£p lÃ½.

---
# Thank you

* https://github.com/ttuan
* tuantv.nhnd@gmail.com
* STK: 049 100 006 3890 - TRAN VAN TUAN - Vietcombank chi nhÃ¡nh ThÄƒng Long. =))




    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
